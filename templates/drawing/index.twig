{% extends "layout.twig" %}

{% block title %}Tirage au sort SOD - {{ parent() }}{% endblock %}

{% block content %}
<div class="neumorphic-container">
    <h1 class="neumorphic-title-red">Tirage au sort Speaker of the Day</h1>

    <form id="drawing-form" class="neumorphic-form">
        <div class="form-group">
            <label for="date">Date du tirage :</label>
            <input type="date" id="date" name="date" class="neumorphic-input" required>
        </div>

        <div class="form-group">
            <label>Cohortes participantes :</label>
            {% for cohort in cohorts %}
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="cohort-{{ cohort.id }}" name="cohort_ids[]" value="{{ cohort.id }}">
                    <label for="cohort-{{ cohort.id }}">{{ cohort.name }}</label>
                </div>
            {% endfor %}
        </div>

        <button type="submit" class="neumorphic-button">Effectuer le tirage</button>
    </form>

    <div id="result" class="neumorphic-card" style="display: none;">
        <h2>Résultat du tirage</h2>
        <p id="selected-student"></p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const drawingForm = document.getElementById('drawing-form');
    const resultDiv = document.getElementById('result');
    const selectedStudentP = document.getElementById('selected-student');

    if (drawingForm) {
        drawingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/drawing/perform', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau ou serveur');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    selectedStudentP.textContent = `Étudiant sélectionné : ${data.student.first_name} ${data.student.last_name}`;
                    resultDiv.style.display = 'block';
                } else {
                    selectedStudentP.textContent = data.message || 'Une erreur est survenue lors du tirage au sort.';
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                selectedStudentP.textContent = 'Une erreur est survenue lors du tirage au sort.';
                resultDiv.style.display = 'block';
            });
        });
    }
});
</script>
{% endblock %}